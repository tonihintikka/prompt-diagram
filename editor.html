<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Diagram Editor</title>
    <style>
        :root {
            color-scheme: light;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            background-color: #f8f9fa;
        }
        header {
            padding: 1rem 1.5rem;
            background: #ffffff;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
        }
        .breadcrumbs a {
            text-decoration: none;
            color: #0d6efd;
            font-weight: 600;
        }
        .breadcrumbs span {
            color: #6c757d;
            margin-left: 0.35rem;
        }
        .actions {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        button {
            background: #0d6efd;
            border: none;
            color: #fff;
            font-weight: 600;
            border-radius: 6px;
            padding: 0.45rem 0.95rem;
            cursor: pointer;
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .secondary-link {
            text-decoration: none;
            color: #0d6efd;
            font-weight: 600;
        }
        .meta-bar {
            padding: 0.6rem 1.5rem;
            background: #f1f3f5;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            font-size: 0.95rem;
        }
        .meta-bar span {
            color: #495057;
        }
        #save-status.error {
            color: #c1121f;
        }
        #save-status.success {
            color: #198754;
        }
        #diagram-editor {
            flex-grow: 1;
            border: none;
        }
    </style>
</head>
<body>
    <header>
        <div class="breadcrumbs">
            <a href="index.html">← Takaisin workspaceen</a>
            <span>/ Editor</span>
        </div>
        <div class="actions">
            <button id="manual-save" type="button" disabled>Tallenna snapshot</button>
            <a class="secondary-link" href="snapshots/index.html" target="_blank">Avaa katalogi</a>
        </div>
    </header>
    <div class="meta-bar">
        <span id="diagram-source">Ladataan kaaviota…</span>
        <span id="save-status"></span>
    </div>
    <iframe id="diagram-editor" title="Diagram Editor" frameborder="0"></iframe>

    <script>
        const iframe = document.getElementById('diagram-editor');
        const saveBtn = document.getElementById('manual-save');
        const sourceEl = document.getElementById('diagram-source');
        const statusEl = document.getElementById('save-status');
        const editorUrl = 'https://embed.diagrams.net/?embed=1&ui=atlas&spin=1&proto=json';

        let initialXml = null;
        let iframeReady = false;
        let pendingSave = null;
        let latestMeta = null;

        function setStatus(message, type = '') {
            statusEl.textContent = message;
            statusEl.className = type ? type : '';
        }

        function postMessage(message) {
            if (iframe.contentWindow) {
                iframe.contentWindow.postMessage(JSON.stringify(message), '*');
            }
        }

        function maybeLoadDiagram() {
            if (initialXml && iframeReady) {
                postMessage({ action: 'load', xml: initialXml });
                saveBtn.disabled = false;
            }
        }

        async function fetchLatestDiagram() {
            try {
                const res = await fetch('/api/latest');
                if (!res.ok) throw new Error('latest diagram missing');
                latestMeta = await res.json();
                initialXml = latestMeta.xml;
                sourceEl.textContent = `Lähde: ${latestMeta.source} (päivitetty ${latestMeta.updated_at})`;
                maybeLoadDiagram();
            } catch (err) {
                sourceEl.textContent = 'Kaaviota ei löytynyt: ' + err.message;
                setStatus('Ei yhteyttä APIin', 'error');
            }
        }

        function requestExport(note = 'Auto-snapshot', title = 'Diagram Snapshot') {
            if (!iframe.contentWindow) return;
            pendingSave = { note, title };
            postMessage({ action: 'export', format: 'xml', xml: 1, spin: 1 });
        }

        async function persistDiagram(xml, context) {
            setStatus('Tallennetaan…');
            try {
                const res = await fetch('/api/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        xml,
                        title: context.title,
                        note: context.note
                    })
                });
                if (!res.ok) {
                    const text = await res.text();
                    throw new Error(text || 'Tuntematon virhe');
                }
                const data = await res.json();
                setStatus(`Tallennettu ${data.timestamp}`, 'success');
            } catch (err) {
                console.error(err);
                setStatus('Tallennus epäonnistui: ' + err.message, 'error');
            }
        }

        window.addEventListener('message', (event) => {
            if (event.source !== iframe.contentWindow || !event.data) return;
            let msg = event.data;
            if (typeof msg === 'string') {
                try { msg = JSON.parse(msg); } catch (_) { return; }
            }
            if (typeof msg !== 'object') return;

            if (msg.event === 'configure') {
                postMessage({ action: 'configure', config: { defaultFonts: [], mathEnabled: false } });
            } else if (msg.event === 'init') {
                iframeReady = true;
                maybeLoadDiagram();
            } else if (msg.event === 'save' || msg.event === 'autosave') {
                requestExport('Auto-save (editor)', 'Diagram Snapshot');
            } else if (msg.event === 'export' && pendingSave) {
                const xml = msg.xml || msg.data;
                if (xml) {
                    persistDiagram(xml, pendingSave);
                }
                pendingSave = null;
                postMessage({ action: 'saved' });
            }
        });

        saveBtn.addEventListener('click', () => {
            requestExport('Manual save from toolbar', 'Diagram Snapshot');
        });

        function init() {
            iframe.src = editorUrl;
            fetchLatestDiagram();
        }

        init();
    </script>
</body>
</html>
